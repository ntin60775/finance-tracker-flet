# Build and Deployment Guidelines

## Правила сборки и развёртывания Finance Tracker

### Обязательные требования для Flet приложений

**КРИТИЧЕСКИ ВАЖНО:** При работе с Flet приложениями ОБЯЗАТЕЛЬНО соблюдать правила запуска для корректной сборки PyInstaller.

#### 1. Режим запуска Flet

**Правило:** Всегда явно указывать `view=ft.AppView.FLET_APP` для десктопных приложений.

**Правильно:**
```python
ft.app(
    target=main, 
    assets_dir="assets",
    view=ft.AppView.FLET_APP  # Обязательно для .exe сборки!
)
```

**НЕПРАВИЛЬНО:**
```python
ft.app(target=main, assets_dir="assets")  # Запустится в веб-режиме!
```

**Причина:** Без явного указания `view` Flet по умолчанию запускается в веб-режиме, который:
- Пытается открыть браузер
- Требует консоль для вывода URL
- С `console=False` в PyInstaller приводит к немедленному закрытию

#### 2. Доступные режимы Flet

- `ft.AppView.FLET_APP` - нативное десктопное окно (рекомендуется)
- `ft.AppView.FLET_APP_HIDDEN` - скрытое десктопное окно
- `ft.AppView.WEB_BROWSER` - веб-браузер (только для веб-версий)

#### 3. Файлы, которые должны содержать правильный запуск

**Обязательно проверить:**
- `src/finance_tracker/__main__.py` - основная точка входа
- `main.py` - точка входа для разработки
- Любые другие файлы запуска

### PyInstaller Configuration

#### 1. Спецификация сборки

**Файл:** `finance_tracker.spec`

**Обязательные параметры:**
```python
exe = EXE(
    # ... другие параметры ...
    console=False,  # Для GUI приложения
    icon=['assets\\icon.ico'],  # Иконка приложения
)
```

#### 2. Включение ресурсов

**Обязательно включить в `datas`:**
```python
datas=[
    ('assets\\icon.ico', 'assets'), 
    ('assets\\icon.png', 'assets')
],
```

#### 3. Hidden imports

**Все модули приложения должны быть в `hiddenimports`:**
- Все сервисы (`finance_tracker.services.*`)
- Все компоненты (`finance_tracker.components.*`)
- Все представления (`finance_tracker.views.*`)
- Утилиты и модели

### Процедура сборки

#### 1. Предварительная проверка

**Перед сборкой ОБЯЗАТЕЛЬНО:**
```bash
# 1. Проверить, что все тесты проходят
pytest tests/ -v

# 2. Проверить запуск в режиме разработки
python -m finance_tracker

# 3. Убедиться, что приложение открывается в нативном окне (не в браузере)
```

#### 2. Команды сборки

**Чистая сборка (рекомендуется):**
```bash
pyinstaller finance_tracker.spec --clean --noconfirm
```

**Быстрая пересборка:**
```bash
pyinstaller finance_tracker.spec --noconfirm
```

#### 3. Тестирование сборки

**После сборки ОБЯЗАТЕЛЬНО:**
```bash
# 1. Запустить собранное приложение
dist\finance_tracker.exe

# 2. Проверить создание логов
# Должен появиться файл: dist\.finance_tracker_data\logs\finance_tracker_*.log

# 3. Проверить, что процесс остаётся активным
Get-Process -Name "finance_tracker"

# 4. Проверить основную функциональность
# - Открытие главного окна
# - Навигация между разделами
# - Создание тестовой транзакции
```

### Отладка проблем сборки

#### 1. Приложение не запускается

**Симптомы:**
- .exe файл запускается и сразу закрывается
- Нет новых логов в `.finance_tracker_data/logs/`

**Решение:**
1. Временно изменить `console=True` в `.spec` файле
2. Пересобрать приложение
3. Запустить из командной строки и посмотреть ошибки
4. Исправить проблему
5. Вернуть `console=False` и пересобрать

#### 2. Приложение открывается в браузере

**Симптомы:**
- Вместо нативного окна открывается браузер
- В консоли видны сообщения о запуске веб-сервера

**Решение:**
- Добавить `view=ft.AppView.FLET_APP` во все точки входа

#### 3. Отсутствуют ресурсы

**Симптомы:**
- Ошибки загрузки иконок
- Отсутствие файлов assets

**Решение:**
- Проверить секцию `datas` в `.spec` файле
- Убедиться, что пути к ресурсам корректны

### Checklist сборки

**Перед каждой сборкой:**
- [ ] Все тесты проходят (`pytest tests/ -v`)
- [ ] Приложение запускается в режиме разработки
- [ ] Указан `view=ft.AppView.FLET_APP` во всех точках входа
- [ ] Обновлена версия в `pyproject.toml` (если нужно)
- [ ] Проверена спецификация PyInstaller

**После сборки:**
- [ ] .exe файл запускается без ошибок
- [ ] Создаются логи в `.finance_tracker_data/logs/`
- [ ] Процесс остаётся активным
- [ ] Открывается нативное окно (не браузер)
- [ ] Основная функциональность работает
- [ ] Иконка приложения отображается корректно

### Распространённые ошибки

#### ❌ Ошибка 1: Веб-режим вместо десктопного
```python
# НЕПРАВИЛЬНО
ft.app(target=main, assets_dir="assets")
```
```python
# ПРАВИЛЬНО
ft.app(target=main, assets_dir="assets", view=ft.AppView.FLET_APP)
```

#### ❌ Ошибка 2: Отсутствие hidden imports
```python
# В .spec файле должны быть ВСЕ модули приложения
hiddenimports=[
    'finance_tracker.services.transaction_service',  # Не забыть!
    # ... все остальные модули
]
```

#### ❌ Ошибка 3: Неправильные пути к ресурсам
```python
# НЕПРАВИЛЬНО (только для Unix)
datas=[('assets/icon.ico', 'assets')]

# ПРАВИЛЬНО (для Windows)
datas=[('assets\\icon.ico', 'assets')]
```

### Автоматизация проверок

**Создан скрипт проверки `build_check.ps1`:**
```bash
# build_check.ps1
Write-Host "Проверка перед сборкой..."

# Проверка тестов
pytest tests/ -q
if ($LASTEXITCODE -ne 0) {
    Write-Error "Тесты не проходят!"
    exit 1
}

# Проверка точек входа
$files = @("src/finance_tracker/__main__.py", "main.py")
foreach ($file in $files) {
    $content = Get-Content $file -Raw
    if ($content -notmatch "view=ft\.AppView\.FLET_APP") {
        Write-Error "В файле $file отсутствует view=ft.AppView.FLET_APP"
        exit 1
    }
}

Write-Host "Все проверки пройдены. Можно собирать приложение."
```

**Использование:**
```powershell
.\build_check.ps1
```

### Версионирование сборок

**При создании релизов:**
1. Обновить версию в `pyproject.toml`
2. Создать тег в Git: `git tag v1.0.0`
3. Собрать приложение
4. Протестировать сборку
5. Создать релиз с приложенным .exe файлом

### Размер приложения

**Ожидаемые размеры:**
- Собранное приложение: ~50-70 MB
- Распакованная папка: ~150-200 MB

**Если размер значительно больше:**
- Проверить `excludes` в `.spec` файле
- Убрать неиспользуемые `hiddenimports`
- Рассмотреть использование `upx=True` для сжатия

### Поддержка разных платформ

**Windows (текущая):**
- Используется `runw.exe` bootloader (без консоли)
- Иконка в формате `.ico`

**Для будущей поддержки Linux/macOS:**
- Изменить пути в `datas` на универсальные
- Использовать соответствующие форматы иконок
- Адаптировать команды сборки

---

**ВАЖНО:** Эти правила должны соблюдаться при каждой сборке приложения. Нарушение может привести к неработающему .exe файлу.