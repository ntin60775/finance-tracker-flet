# Implementation Plan: Calendar Legend Improvement

## Overview

Реализация улучшенной календарной легенды с отображением всех индикаторов в одну строку, адаптивностью к ширине календаря и исправлением неработающей кнопки "Подробнее".

## Tasks

- [x] 1. Создание новых моделей и типов данных
  - Создать enum IndicatorType с 7 типами индикаторов
  - Создать dataclass LegendIndicator с полями type, visual_element, label, description, priority, estimated_width
  - Создать enum DisplayMode с режимами AUTO, FULL, COMPACT, MODAL_ONLY
  - Создать конфигурацию INDICATOR_CONFIGS с настройками всех индикаторов
  - _Requirements: 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8_

- [x] 1.1 Написать property тест для моделей данных
  - **Property 1: Complete indicator display**
  - **Validates: Requirements 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8**

- [x] 2. Создание ModalManager класса
  - Реализовать класс ModalManager для управления модальным окном
  - Добавить метод create_modal() для создания модального окна с группировкой индикаторов
  - Добавить методы open_modal() и close_modal() с безопасной обработкой page объекта
  - Реализовать группировку индикаторов по типам (точки, символы, фон)
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 2.1 Написать property тест для ModalManager
  - **Property 5: Modal dialog functionality**
  - **Property 6: Modal dialog structure**
  - **Property 7: Page object handling**
  - **Validates: Requirements 3.1, 3.2, 3.3, 3.4, 3.5**

- [x] 3. Реализация вычисления ширины и адаптивности
  - Добавить метод _calculate_required_width() для вычисления необходимой ширины
  - Реализовать метод _should_show_full_legend() для определения режима отображения
  - Добавить логику приоритизации индикаторов при ограниченном пространстве
  - Реализовать автоматическое определение доступной ширины
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [x] 3.1 Написать property тесты для адаптивности
  - **Property 2: Adaptive layout behavior**
  - **Property 3: Width calculation accuracy**
  - **Property 4: Priority-based indicator selection**
  - **Validates: Requirements 2.1, 2.2, 2.3, 2.4**

- [x] 4. Обновление CalendarLegend класса
  - Обновить конструктор для принятия calendar_width параметра
  - Реализовать методы _build_full_legend() и _build_compact_legend()
  - Добавить безопасный метод _safe_get_page() для работы с page объектом
  - Обновить метод _open_dlg() с использованием _open_modal_safe()
  - Обновить метод _close_dlg() с безопасной обработкой ошибок
  - _Requirements: 1.1, 1.9, 5.2, 5.3_

- [x] 4.1 Написать UI тесты для CalendarLegend
  - Тест атрибутов кнопки "Подробнее"
  - Тест открытия модального окна при клике
  - Тест видимости кнопки в зависимости от ширины
  - Тест содержимого модального окна
  - Тест кнопки закрытия модального окна
  - **Property 12: Event handling robustness**
  - **Validates: Requirements 3.1, 3.4, 5.2, 5.3**

- [x] 5. Реализация визуальных улучшений
  - Обновить _build_legend_item() для поддержки всех типов индикаторов
  - Реализовать консистентность цветов и символов с календарём
  - Добавить правильное выравнивание элементов по центру
  - Настроить подходящие отступы между элементами (spacing=20)
  - Реализовать визуальную группировку похожих индикаторов
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 5.1 Написать property тесты для визуализации
  - **Property 8: Visual consistency**
  - **Property 9: Layout alignment**
  - **Property 10: Readability standards**
  - **Property 11: Visual grouping**
  - **Validates: Requirements 4.1, 4.2, 4.3, 4.4, 4.5**

- [x] 6. Checkpoint - Тестирование основной функциональности
  - Убедиться, что все unit тесты проходят
  - Проверить корректность отображения всех 7 индикаторов
  - Протестировать адаптивное поведение при разных ширинах
  - Проверить работу кнопки "Подробнее" и модального окна
  - Убедиться в отсутствии ошибок при работе без page объекта
  - Ensure all tests pass, ask the user if questions arise.

- [ ] 7. Интеграция с HomeView
  - Обновить HomeView для передачи ширины календаря в CalendarLegend
  - Добавить логику получения ширины календарного виджета
  - Обновить создание CalendarLegend с параметром calendar_width
  - Протестировать интеграцию с существующим календарём
  - _Requirements: 1.1, 2.1, 2.2_

- [ ] 7.1 Написать интеграционные тесты
  - Тест интеграции CalendarLegend с HomeView
  - Тест передачи ширины календаря
  - Тест консистентности индикаторов между календарём и легендой
  - **Property 13: Responsive stability**
  - **Validates: Requirements 5.5**

- [ ] 8. Обработка ошибок и стабильность
  - Добавить try-catch блоки в критических местах
  - Реализовать fallback значения при ошибках вычисления ширины
  - Добавить логирование ошибок с контекстом
  - Протестировать стабильность при изменении размеров окна
  - _Requirements: 5.2, 5.3, 5.5_

- [ ] 8.1 Написать тесты обработки ошибок
  - Тест обработки ошибок при отсутствии page объекта
  - Тест fallback значений при ошибках вычисления ширины
  - Тест стабильности при изменении размеров окна
  - **Property 7: Page object handling**
  - **Validates: Requirements 5.2, 5.3, 5.5**

- [ ] 9. Финальное тестирование и оптимизация
  - Запустить полный набор тестов (unit + property + UI + integration)
  - Проверить покрытие кода (должно быть > 80% для новых компонентов)
  - Протестировать все сценарии использования вручную
  - Оптимизировать производительность при необходимости
  - Обновить документацию компонента
  - _Requirements: все требования_

- [ ] 9.1 Написать финальные property тесты
  - Комплексные property тесты для всех сценариев
  - Тесты граничных случаев (минимальная/максимальная ширина)
  - Стресс-тесты с множественными изменениями размеров
  - **Validates: все Requirements**

- [ ] 10. Final checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

## Notes

- Все тесты являются обязательными для комплексного подхода к разработке
- Каждая задача ссылается на конкретные требования для отслеживания
- Checkpoint'ы обеспечивают инкрементальную валидацию
- Property тесты валидируют универсальные свойства корректности
- UI тесты обязательны согласно новым правилам проекта
- Интеграционные тесты проверяют взаимодействие с существующими компонентами