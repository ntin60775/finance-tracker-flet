# Requirements Document: Кнопка добавления плановых транзакций

## Введение

Данная спецификация описывает функциональность добавления кнопки для создания новых плановых транзакций на панели плановых транзакций главного экрана.

## Глоссарий

- **Плановая транзакция (Planned Transaction)**: Периодическая или однократная транзакция, которая будет автоматически создана в будущем
- **Вхождение (Occurrence)**: Конкретный экземпляр плановой транзакции на определённую дату
- **Виджет плановых транзакций (PlannedTransactionsWidget)**: UI компонент на главном экране, отображающий список ближайших плановых вхождений
- **Модальное окно (Modal)**: Диалоговое окно для ввода данных пользователем
- **HomeView**: Главный экран приложения
- **Presenter**: Компонент, содержащий бизнес-логику (паттерн MVP)

## Требования

### Requirement 1: Кнопка добавления плановой транзакции

**User Story:** Как пользователь, я хочу иметь возможность быстро добавить новую плановую транзакцию прямо с главного экрана, чтобы не переходить в отдельный раздел.

#### Acceptance Criteria

1. WHEN пользователь находится на главном экране, THE виджет плановых транзакций SHALL отображать кнопку "Добавить плановую транзакцию"
2. WHEN пользователь нажимает кнопку "Добавить плановую транзакцию", THE система SHALL открывать модальное окно создания плановой транзакции
3. WHEN пользователь заполняет форму и сохраняет плановую транзакцию, THE система SHALL создавать новую плановую транзакцию в базе данных
4. WHEN плановая транзакция успешно создана, THE система SHALL обновлять виджет плановых транзакций с новыми вхождениями
5. WHEN плановая транзакция успешно создана, THE система SHALL показывать уведомление об успешном создании

### Requirement 2: Расположение кнопки добавления

**User Story:** Как пользователь, я хочу, чтобы кнопка добавления плановой транзакции была легко доступна и интуитивно понятна, чтобы быстро создавать новые плановые транзакции.

#### Acceptance Criteria

1. WHEN виджет отображается, THE кнопка "Добавить плановую транзакцию" SHALL располагаться в заголовке виджета рядом с кнопкой "Показать все"
2. WHEN виджет отображается, THE кнопка SHALL иметь иконку "+" (ft.Icons.ADD)
3. WHEN виджет отображается, THE кнопка SHALL иметь tooltip "Добавить плановую транзакцию"
4. WHEN виджет отображается, THE кнопка SHALL быть визуально отличима от других элементов (цвет PRIMARY)

### Requirement 3: Интеграция модального окна с HomeView

**User Story:** Как разработчик, я хочу правильно интегрировать модальное окно создания плановых транзакций с главным экраном, чтобы обеспечить корректную работу функционала.

#### Acceptance Criteria

1. WHEN HomeView инициализируется, THE модальное окно PlannedTransactionModal SHALL быть создано с правильными callback функциями
2. WHEN пользователь сохраняет новую плановую транзакцию в модальном окне, THE callback SHALL вызывать метод Presenter для создания плановой транзакции
3. WHEN Presenter создаёт плановую транзакцию, THE система SHALL обновлять все зависимые компоненты (виджет, календарь)
4. WHEN происходит ошибка при создании плановой транзакции, THE система SHALL показывать сообщение об ошибке пользователю

### Requirement 4: Обновление данных после создания

**User Story:** Как пользователь, я хочу сразу видеть созданные вхождения в списке, чтобы убедиться, что плановая транзакция была успешно добавлена.

#### Acceptance Criteria

1. WHEN плановая транзакция создана, THE виджет плановых транзакций SHALL обновить список вхождений
2. WHEN плановая транзакция создана, THE календарь SHALL отобразить индикаторы плановых вхождений на соответствующих датах
3. WHEN плановая транзакция создана, THE модальное окно SHALL закрыться автоматически
4. WHEN плановая транзакция создана, THE система SHALL показать SnackBar с сообщением об успехе

### Requirement 5: Валидация и обработка ошибок

**User Story:** Как пользователь, я хочу получать понятные сообщения об ошибках, чтобы исправить некорректные данные.

#### Acceptance Criteria

1. WHEN пользователь пытается сохранить плановую транзакцию с пустыми обязательными полями, THE система SHALL показывать сообщения об ошибках валидации
2. WHEN происходит ошибка при сохранении в базу данных, THE система SHALL показывать сообщение об ошибке
3. WHEN происходит ошибка, THE модальное окно SHALL оставаться открытым для исправления данных
4. WHEN пользователь исправляет ошибки, THE сообщения об ошибках SHALL исчезать

### Requirement 6: Использование современного Flet API

**User Story:** Как разработчик, я хочу использовать современный Flet API для работы с диалогами, чтобы обеспечить совместимость с новыми версиями Flet.

#### Acceptance Criteria

1. WHEN модальное окно открывается, THE система SHALL использовать `page.open()` для открытия диалога
2. WHEN модальное окно закрывается, THE система SHALL использовать `page.close()` для закрытия диалога
3. WHEN модальное окно используется, THE система SHALL НЕ использовать deprecated методы (`page.dialog =`, `dialog.open = True`)
4. WHEN модальное окно тестируется, THE тесты SHALL проверять вызовы `page.open()` и `page.close()`

## Технические детали

### Изменения в PlannedTransactionsWidget

1. Добавить кнопку "Добавить плановую транзакцию" в заголовок виджета
2. Добавить callback `on_add_planned_transaction` для обработки нажатия кнопки
3. Обновить layout заголовка для размещения новой кнопки

### Изменения в HomeView

1. Обновить инициализацию `PlannedTransactionModal` с правильным callback `on_save`
2. Добавить метод `on_add_planned_transaction` для открытия модального окна
3. Добавить метод `on_planned_transaction_saved` для обработки сохранения
4. Реализовать обновление виджета и календаря после создания

### Изменения в HomePresenter

1. Добавить метод `create_planned_transaction` для создания плановой транзакции через сервис
2. Обновить метод `refresh_data` для обновления виджета после создания
3. Добавить обработку ошибок при создании плановой транзакции

## Зависимости

- Существующий `PlannedTransactionModal` (уже реализован)
- Существующий `PlannedTransactionsWidget` (требует модификации)
- Существующий `HomeView` (требует модификации)
- Существующий `HomePresenter` (требует модификации)
- Существующий `planned_transaction_service` (уже реализован)
- Существующий раздел "Плановые транзакции" в MainWindow

## Ограничения

1. Модальное окно должно использовать современный Flet API (`page.open()`, `page.close()`)
2. Все изменения должны соответствовать паттерну MVP
3. Все callback должны быть правильно типизированы
4. Логирование всех операций обязательно
5. Кнопка должна быть видна только когда виджет отображается на главном экране
