# Implementation Plan: Calendar Selection Sync Fix

## Overview

Исправление синхронизации визуального выделения даты в календаре при клике на карточку плановой транзакции. Проблема заключается в том, что календарь не обновляет визуальное выделение, хотя панель транзакций переключается на правильную дату.

## Tasks

- [ ] 1. Исследование и диагностика проблемы
  - Проверить, вызывается ли `calendar_widget.select_date()` при клике на плановую транзакцию
  - Проверить, доступен ли `self.page` в момент вызова `_update_calendar()`
  - Проверить, вызывается ли `self.update()` в конце `_update_calendar()`
  - Добавить логирование для отслеживания последовательности вызовов
  - _Requirements: 1.1, 2.1, 2.4_

- [ ] 2. Исправление метода select_date в CalendarWidget
  - [ ] 2.1 Добавить проверку доступности page перед обновлением
    - Добавить логирование, если `self.page` недоступен
    - Убедиться, что метод не завершается раньше времени
    - _Requirements: 2.1, 2.4_
  
  - [ ] 2.2 Написать unit тест для select_date с датой текущего месяца
    - **Property 1: Синхронизация выделения календаря**
    - **Validates: Requirements 1.1, 1.3**
    - Проверить обновление `selected_date`
    - Проверить вызов `_update_calendar()`
    - Проверить НЕ вызов `on_date_selected` callback
  
  - [ ] 2.3 Написать unit тест для select_date с датой другого месяца
    - **Property 2: Переключение месяца при необходимости**
    - **Validates: Requirements 1.4, 1.5**
    - Проверить переключение `current_date`
    - Проверить загрузку данных для нового месяца
    - Проверить вызов `_update_calendar()`

- [ ] 3. Улучшение callback update_calendar_selection в HomeView
  - [ ] 3.1 Добавить логирование в метод update_calendar_selection
    - Логировать входящую дату
    - Логировать результат вызова `calendar_widget.select_date()`
    - _Requirements: 3.4, 3.5_
  
  - [ ] 3.2 Написать unit тест для update_calendar_selection
    - Проверить делегирование в `calendar_widget.select_date()`
    - Проверить передачу правильной даты
    - Проверить обработку ошибок

- [ ] 4. Checkpoint - Проверка базовой функциональности
  - Запустить приложение и проверить клик на плановую транзакцию
  - Убедиться, что календарь обновляет выделение
  - Проверить переключение месяца при необходимости
  - Проверить логи на наличие ошибок
  - Спросить пользователя, если возникли вопросы

- [ ] 5. Написать integration тесты
  - [ ] 5.1 Написать тест полного сценария клика на плановую транзакцию
    - Создать HomeView с реальными компонентами
    - Создать плановое вхождение с датой
    - Симулировать клик на карточку
    - Проверить обновление календаря, панели транзакций
    - _Requirements: 1.1, 1.2, 1.3_
  
  - [ ] 5.2 Написать тест сценария переключения месяца
    - Установить текущий месяц
    - Кликнуть на вхождение из другого месяца
    - Проверить переключение месяца
    - Проверить загрузку данных
    - Проверить выделение даты
    - _Requirements: 1.4, 1.5_

- [ ] 6. Написать property-based тесты
  - [ ] 6.1 Написать property тест синхронизации выделения для любой даты
    - **Property 1: Синхронизация выделения календаря**
    - **Validates: Requirements 1.1, 1.3**
    - Генерировать случайные даты
    - Проверять выделение после клика на вхождение
  
  - [ ] 6.2 Написать property тест переключения месяца для любых дат
    - **Property 2: Переключение месяца при необходимости**
    - **Validates: Requirements 1.4, 1.5**
    - Генерировать пары дат из разных месяцев
    - Проверять переключение месяца
  
  - [ ] 6.3 Написать property тест программного обновления без callback
    - **Property 3: Программное обновление без callback**
    - **Validates: Requirements 2.3**
    - Генерировать случайные даты
    - Проверять, что callback НЕ вызывается

- [ ] 7. Final checkpoint - Убедиться, что все тесты проходят
  - Запустить все unit тесты
  - Запустить все integration тесты
  - Запустить все property-based тесты (минимум 100 итераций)
  - Проверить coverage (цель: 90%+)
  - Спросить пользователя, если возникли вопросы

## Notes

- Все задачи являются обязательными для комплексного решения
- Каждая задача ссылается на конкретные требования для трассируемости
- Checkpoints обеспечивают инкрементальную валидацию
- Property тесты валидируют универсальные свойства корректности
- Unit тесты валидируют конкретные примеры и граничные случаи
