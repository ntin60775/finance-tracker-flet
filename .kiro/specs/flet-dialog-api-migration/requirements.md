# Requirements Document: Миграция на современный Flet Dialog API

## Introduction

Проект Finance Tracker использует Flet framework для построения пользовательского интерфейса. В процессе разработки было обнаружено, что существует два способа работы с диалогами в Flet, и проект должен использовать единый современный подход `page.open()` / `page.close()` для всех диалоговых окон.

Данная спецификация описывает требования к проверке и миграции всего кода (тестов и production кода) на использование современного Flet Dialog API.

## Glossary

- **Dialog API** - программный интерфейс для работы с диалоговыми окнами в Flet
- **page.open()** - современный метод Flet для открытия overlay компонентов (диалоги, SnackBar, BottomSheet)
- **page.close()** - современный метод Flet для закрытия overlay компонентов
- **Классический способ** - устаревший подход через `page.dialog = dialog; dialog.open = True; page.update()`
- **Overlay компоненты** - UI элементы, отображаемые поверх основного интерфейса (AlertDialog, BottomSheet, SnackBar)
- **Mock объект** - тестовый объект, имитирующий поведение реального компонента
- **Production код** - код приложения, выполняющийся в продакшене (не тестовый код)

## Requirements

### Requirement 1: Проверка тестового кода

**User Story:** Как разработчик, я хочу убедиться, что все тесты используют современный Flet Dialog API, чтобы тесты соответствовали актуальным best practices и корректно проверяли поведение приложения.

#### Acceptance Criteria

1. WHEN проверяется тестовый файл THEN система SHALL найти все использования методов работы с диалогами
2. WHEN обнаружено использование `page.dialog =` THEN система SHALL пометить это как устаревший API
3. WHEN обнаружено использование `dialog.open = True` THEN система SHALL пометить это как устаревший API
4. WHEN обнаружено использование `page.open(dialog)` THEN система SHALL пометить это как современный API
5. WHEN обнаружено использование `page.close(dialog)` THEN система SHALL пометить это как современный API
6. WHEN проверка завершена THEN система SHALL создать отчёт со списком файлов, использующих устаревший API

### Requirement 2: Проверка production кода

**User Story:** Как разработчик, я хочу убедиться, что весь production код использует современный Flet Dialog API, чтобы приложение использовало актуальные методы framework'а.

#### Acceptance Criteria

1. WHEN проверяется production файл THEN система SHALL найти все использования методов работы с диалогами
2. WHEN обнаружено использование `page.dialog =` в production коде THEN система SHALL пометить это как требующее миграции
3. WHEN обнаружено использование `dialog.open = True` в production коде THEN система SHALL пометить это как требующее миграции
4. WHEN обнаружено использование `page.update()` после установки диалога THEN система SHALL проверить контекст использования
5. WHEN проверка завершена THEN система SHALL создать отчёт со списком файлов, требующих миграции
6. WHEN найдены файлы для миграции THEN отчёт SHALL содержать номера строк и фрагменты кода

### Requirement 3: Проверка mock объектов

**User Story:** Как разработчик, я хочу убедиться, что все mock объекты для Page имеют методы `open()` и `close()`, чтобы тесты корректно проверяли взаимодействие с диалогами.

#### Acceptance Criteria

1. WHEN проверяется тестовый файл с mock объектами THEN система SHALL найти все создания mock для Page
2. WHEN найден mock объект Page THEN система SHALL проверить наличие метода `open`
3. WHEN найден mock объект Page THEN система SHALL проверить наличие метода `close`
4. WHEN mock объект не имеет метода `open` или `close` THEN система SHALL пометить это как требующее исправления
5. WHEN проверка завершена THEN система SHALL создать отчёт с mock объектами, требующими обновления

### Requirement 4: Автоматическая миграция тестов

**User Story:** Как разработчик, я хочу автоматически мигрировать тесты на современный API, чтобы ускорить процесс обновления кодовой базы.

#### Acceptance Criteria

1. WHEN запущена миграция тестового файла THEN система SHALL заменить `page.dialog = dialog` на использование `page.open(dialog)`
2. WHEN запущена миграция тестового файла THEN система SHALL заменить `dialog.open = True` на использование `page.open(dialog)`
3. WHEN запущена миграция тестового файла THEN система SHALL удалить избыточные вызовы `page.update()` после работы с диалогами
4. WHEN миграция завершена THEN система SHALL создать резервную копию оригинального файла
5. WHEN миграция завершена THEN система SHALL запустить тесты для проверки корректности миграции
6. WHEN тесты не проходят после миграции THEN система SHALL восстановить оригинальный файл и сообщить об ошибке

### Requirement 5: Автоматическая миграция production кода

**User Story:** Как разработчик, я хочу автоматически мигрировать production код на современный API, чтобы обеспечить единообразие использования Flet API в проекте.

#### Acceptance Criteria

1. WHEN запущена миграция production файла THEN система SHALL заменить `page.dialog = dialog; dialog.open = True; page.update()` на `page.open(dialog)`
2. WHEN запущена миграция production файла THEN система SHALL заменить `dialog.open = False; page.update()` на `page.close(dialog)`
3. WHEN миграция затрагивает сложную логику THEN система SHALL сохранить семантику оригинального кода
4. WHEN миграция завершена THEN система SHALL создать резервную копию оригинального файла
5. WHEN миграция завершена THEN система SHALL запустить все тесты для проверки корректности
6. WHEN тесты не проходят после миграции THEN система SHALL восстановить оригинальный файл и сообщить об ошибке

### Requirement 7: Валидация после миграции

**User Story:** Как разработчик, я хочу автоматически проверить корректность миграции, чтобы убедиться, что все изменения не нарушили функциональность приложения.

#### Acceptance Criteria

1. WHEN миграция завершена THEN система SHALL запустить полный набор тестов
2. WHEN тесты запущены THEN система SHALL собрать статистику прохождения тестов
3. WHEN все тесты проходят THEN система SHALL пометить миграцию как успешную
4. WHEN некоторые тесты не проходят THEN система SHALL создать список упавших тестов
5. WHEN тесты не проходят THEN система SHALL предложить откатить изменения
6. WHEN пользователь подтверждает откат THEN система SHALL восстановить все оригинальные файлы из резервных копий

### Requirement 8: Обновление steering правил

**User Story:** Как разработчик, я хочу, чтобы steering правила проекта были обновлены с требованием использования современного API, чтобы новый код автоматически следовал best practices.

#### Acceptance Criteria

1. WHEN миграция успешно завершена THEN система SHALL проверить актуальность steering правил
2. WHEN steering правила не содержат требования о `page.open()` THEN система SHALL добавить соответствующий раздел
3. WHEN steering правила обновлены THEN они SHALL содержать примеры правильного использования API
4. WHEN steering правила обновлены THEN они SHALL содержать примеры неправильного использования API
5. WHEN steering правила обновлены THEN они SHALL содержать checklist для проверки нового кода
6. WHEN обновление правил завершено THEN система SHALL создать commit с изменениями

### Requirement 9: Поиск паттернов использования

**User Story:** Как разработчик, я хочу найти все паттерны использования диалогов в проекте, чтобы понимать полный объём работ по миграции.

#### Acceptance Criteria

1. WHEN запущен поиск паттернов THEN система SHALL найти все файлы, содержащие работу с диалогами
2. WHEN найдены файлы THEN система SHALL классифицировать их по типу (тесты/production)
3. WHEN найдены файлы THEN система SHALL определить используемый API (современный/устаревший)
4. WHEN найдены файлы THEN система SHALL оценить сложность миграции (простая/средняя/сложная)
5. WHEN поиск завершён THEN система SHALL создать сводный отчёт с метриками
6. WHEN создан отчёт THEN он SHALL содержать рекомендации по порядку миграции файлов

### Requirement 10: Интеграция с CI/CD

**User Story:** Как разработчик, я хочу, чтобы проверка использования современного API была интегрирована в CI/CD pipeline, чтобы предотвратить добавление кода с устаревшим API.

#### Acceptance Criteria

1. WHEN создаётся pull request THEN CI SHALL проверить все изменённые файлы на использование устаревшего API
2. WHEN обнаружено использование устаревшего API THEN CI SHALL пометить PR как требующий изменений
3. WHEN обнаружено использование устаревшего API THEN CI SHALL добавить комментарий с указанием проблемных мест
4. WHEN все файлы используют современный API THEN CI SHALL пометить проверку как успешную
5. WHEN проверка завершена THEN CI SHALL добавить badge со статусом проверки API
6. WHEN настроена CI проверка THEN она SHALL быть обязательной для merge PR

## Notes

### Приоритеты миграции

1. **Высокий приоритет**: Тесты - они должны быть мигрированы первыми, чтобы обеспечить корректную проверку production кода
2. **Средний приоритет**: Production код в компонентах (components/) - часто используемые UI элементы
3. **Низкий приоритет**: Production код в views - менее критичные изменения

### Риски

1. **Изменение поведения**: Миграция может изменить порядок выполнения кода, что может привести к неожиданным эффектам
2. **Сложные паттерны**: Некоторые файлы могут использовать сложную логику работы с диалогами, требующую ручной миграции
3. **Зависимости**: Изменения в одном файле могут повлиять на другие файлы

### Ограничения

1. Автоматическая миграция применима только к простым паттернам использования
2. Сложные случаи требуют ручной проверки и миграции
3. Миграция не должна изменять функциональность приложения

### Исключения

Следующие файлы НЕ требуют миграции:
- Файлы в `.hypothesis/` - сгенерированные данные для property-based тестов
- Файлы в `build/` и `dist/` - артефакты сборки
- Файлы в `.git/` - служебные файлы Git
- Файлы документации (README.md, ROADMAP.md и т.д.)
