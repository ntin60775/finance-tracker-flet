# Requirements Document

## Introduction

Функциональность "Передача долга между кредиторами" позволяет отслеживать историю смены держателей долга по кредиту. Типичный сценарий: МФО продаёт просроченный долг коллекторскому агентству. Пользователю важно знать, кому он изначально был должен, кому должен сейчас, и как менялась сумма долга при передачах.

## Glossary

- **Debt_Transfer_System**: Система управления передачей долга между кредиторами
- **Debt_Transfer**: Запись о передаче долга от одного кредитора к другому
- **Loan**: Кредит или займ, по которому происходит передача
- **Lender**: Кредитор (займодатель) — банк, МФО, коллектор или физическое лицо
- **Original_Lender**: Исходный кредитор, выдавший кредит
- **Current_Holder**: Текущий держатель долга
- **Transfer_Amount**: Сумма долга на момент передачи (может отличаться от исходной из-за пеней)

## Requirements

### Requirement 1: Добавление типа кредитора "Коллектор"

**User Story:** As a пользователь, I want различать коллекторские агентства от других типов кредиторов, so that я могу корректно классифицировать держателей долга.

#### Acceptance Criteria

1. THE Debt_Transfer_System SHALL поддерживать тип кредитора COLLECTOR в перечислении LenderType
2. WHEN пользователь создаёт нового кредитора, THE Debt_Transfer_System SHALL предоставлять опцию выбора типа "Коллектор"
3. THE Debt_Transfer_System SHALL отображать тип "Коллектор" с соответствующей иконкой и цветовой индикацией в UI

### Requirement 2: Создание записи о передаче долга

**User Story:** As a пользователь, I want зафиксировать факт передачи долга новому кредитору, so that я могу отслеживать историю смены держателей.

#### Acceptance Criteria

1. WHEN пользователь инициирует передачу долга, THE Debt_Transfer_System SHALL создать запись DebtTransfer с обязательными полями: loan_id, from_lender_id, to_lender_id, transfer_date, transfer_amount
2. WHEN передача долга создаётся, THE Debt_Transfer_System SHALL автоматически обновить current_holder_id в записи Loan
3. WHEN передача долга создаётся, THE Debt_Transfer_System SHALL сохранить original_lender_id в записи Loan, если это первая передача
4. IF transfer_amount отличается от текущего остатка долга, THEN THE Debt_Transfer_System SHALL зафиксировать разницу как изменение суммы долга
5. THE Debt_Transfer_System SHALL валидировать, что from_lender_id соответствует текущему держателю долга

### Requirement 3: Просмотр истории передач долга

**User Story:** As a пользователь, I want видеть полную историю передач долга, so that я понимаю, как менялись держатели и сумма долга.

#### Acceptance Criteria

1. WHEN пользователь открывает детали кредита, THE Debt_Transfer_System SHALL отображать секцию "История передач" со списком всех передач
2. THE Debt_Transfer_System SHALL отображать для каждой передачи: дату, от кого, кому, сумму на момент передачи, изменение суммы
3. THE Debt_Transfer_System SHALL отображать цепочку передач в хронологическом порядке
4. WHEN долг был передан, THE Debt_Transfer_System SHALL явно показывать в заголовке кредита: "Долг передан от [Original_Lender] к [Current_Holder]"

### Requirement 4: Обновление платежей после передачи

**User Story:** As a пользователь, I want чтобы будущие платежи автоматически привязывались к новому держателю долга, so that отчёты корректно отражают, кому я плачу.

#### Acceptance Criteria

1. WHEN передача долга создаётся, THE Debt_Transfer_System SHALL обновить все будущие (PENDING) платежи LoanPayment для привязки к новому держателю
2. THE Debt_Transfer_System SHALL сохранить историю платежей до передачи без изменений
3. WHEN пользователь создаёт новый платёж после передачи, THE Debt_Transfer_System SHALL автоматически привязать его к текущему держателю долга

### Requirement 5: Отображение статуса передачи в UI

**User Story:** As a пользователь, I want визуально различать кредиты с переданным долгом, so that я сразу вижу, какие кредиты сменили держателя.

#### Acceptance Criteria

1. THE Debt_Transfer_System SHALL отображать индикатор "Долг передан" в списке кредитов для кредитов с историей передач
2. THE Debt_Transfer_System SHALL использовать специальную иконку или бейдж для обозначения переданного долга
3. WHEN пользователь наводит на индикатор, THE Debt_Transfer_System SHALL показывать tooltip с краткой информацией: "Передан от [Original] к [Current] [Date]"

### Requirement 6: Валидация и ограничения передачи

**User Story:** As a система, I want предотвращать некорректные передачи долга, so that данные остаются консистентными.

#### Acceptance Criteria

1. IF кредит имеет статус PAID_OFF, THEN THE Debt_Transfer_System SHALL запретить создание передачи долга
2. IF to_lender_id равен from_lender_id, THEN THE Debt_Transfer_System SHALL отклонить передачу с сообщением об ошибке
3. IF transfer_amount меньше или равен нулю, THEN THE Debt_Transfer_System SHALL отклонить передачу с сообщением об ошибке
4. THE Debt_Transfer_System SHALL требовать подтверждения пользователя перед созданием передачи

### Requirement 7: Интеграция с отчётами

**User Story:** As a пользователь, I want видеть информацию о передачах в отчётах по кредитам, so that я имею полную картину своих обязательств.

#### Acceptance Criteria

1. THE Debt_Transfer_System SHALL включать информацию о текущем держателе долга в статистику по кредитам
2. THE Debt_Transfer_System SHALL группировать задолженности по текущим держателям в сводных отчётах
3. WHEN отображается общая задолженность перед кредитором, THE Debt_Transfer_System SHALL учитывать только кредиты, где этот кредитор является текущим держателем

### Requirement 8: Модальное окно передачи долга

**User Story:** As a пользователь, I want удобный интерфейс для оформления передачи долга, so that процесс передачи прост и понятен.

#### Acceptance Criteria

1. THE Debt_Transfer_System SHALL предоставлять модальное окно для создания передачи долга
2. THE Debt_Transfer_System SHALL отображать в модальном окне: текущего держателя, текущий остаток долга, поле выбора нового держателя, поле даты передачи, поле суммы долга при передаче
3. THE Debt_Transfer_System SHALL предзаполнять сумму передачи текущим остатком долга
4. THE Debt_Transfer_System SHALL позволять создать нового кредитора прямо из модального окна передачи
5. WHEN пользователь изменяет сумму передачи, THE Debt_Transfer_System SHALL показывать разницу с текущим остатком (например: "+5000 ₽ (пени)")
