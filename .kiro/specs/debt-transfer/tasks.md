# Implementation Plan: Передача долга между кредиторами

## Overview

Реализация функциональности передачи долга между кредиторами. Включает расширение моделей данных, создание сервиса передачи, UI компоненты и интеграцию с существующей системой кредитов.

## Tasks

- [x] 1. Расширение моделей данных
  - [x] 1.1 Добавить тип COLLECTOR в LenderType
    - Добавить значение `COLLECTOR = "collector"` в enum `LenderType` в `models/enums.py`
    - _Requirements: 1.1_
  - [x] 1.2 Создать модель DebtTransferDB
    - Создать класс `DebtTransferDB` в `models/models.py` со всеми полями и связями
    - Добавить индексы для производительности
    - _Requirements: 2.1_
  - [x] 1.3 Расширить модель LoanDB
    - Добавить поля `original_lender_id` и `current_holder_id`
    - Добавить связи `original_lender`, `current_holder`, `debt_transfers`
    - Добавить свойства `is_transferred` и `effective_holder_id`
    - _Requirements: 2.2, 2.3_
  - [x] 1.4 Создать Pydantic модели для передачи долга
    - Создать `DebtTransferCreate` и `DebtTransfer` в `models/models.py`
    - _Requirements: 2.1_

- [x] 2. Реализация сервиса передачи долга
  - [x] 2.1 Создать файл debt_transfer_service.py
    - Создать файл `services/debt_transfer_service.py` с базовой структурой
    - Добавить импорты и логгер
    - _Requirements: 2.1_
  - [x] 2.2 Реализовать функцию validate_transfer
    - Проверка существования кредита и кредитора
    - Проверка статуса кредита (не PAID_OFF)
    - Проверка что to_lender_id != current_holder
    - Проверка что transfer_amount > 0
    - _Requirements: 6.1, 6.2, 6.3, 2.5_
  - [x] 2.3 Написать property test для валидации передачи
    - **Property 4: Валидация источника передачи**
    - **Property 8: Запрет передачи погашенного кредита**
    - **Property 9: Запрет передачи самому себе**
    - **Property 10: Запрет отрицательной или нулевой суммы**
    - **Validates: Requirements 2.5, 6.1, 6.2, 6.3**
  - [x] 2.4 Реализовать функцию get_remaining_debt
    - Вычисление текущего остатка долга по кредиту
    - Учёт выполненных платежей
    - _Requirements: 8.3_
  - [x] 2.5 Реализовать функцию create_debt_transfer
    - Создание записи DebtTransferDB
    - Обновление loan.current_holder_id
    - Установка loan.original_lender_id при первой передаче
    - Вычисление amount_difference
    - _Requirements: 2.1, 2.2, 2.3, 2.4_
  - [x] 2.6 Написать property test для создания передачи
    - **Property 1: Консистентность текущего держателя после передачи**
    - **Property 2: Неизменность исходного кредитора**
    - **Property 3: Корректность вычисления разницы сумм**
    - **Validates: Requirements 2.2, 2.3, 2.4, 4.3**
  - [x] 2.7 Реализовать функцию get_transfer_history
    - Получение списка передач по loan_id
    - Сортировка по дате в хронологическом порядке
    - _Requirements: 3.2, 3.3_
  - [x] 2.8 Написать property test для истории передач
    - **Property 5: Хронологический порядок истории передач**
    - **Validates: Requirements 3.3**
  - [x] 2.9 Реализовать обновление платежей при передаче
    - Обновление PENDING платежей для привязки к новому держателю
    - Сохранение EXECUTED платежей без изменений
    - _Requirements: 4.1, 4.2_
  - [x] 2.10 Написать property test для обновления платежей
    - **Property 6: Неизменность исполненных платежей при передаче**
    - **Property 7: Обновление ожидающих платежей при передаче**
    - **Validates: Requirements 4.1, 4.2**

- [x] 3. Checkpoint - Проверка сервисного слоя
  - Убедиться, что все тесты проходят
  - Проверить логирование операций
  - Спросить пользователя, если есть вопросы

- [x] 4. Расширение loan_service для работы с держателями
  - [x] 4.1 Добавить функцию get_loans_by_current_holder
    - Получение кредитов по текущему держателю долга
    - _Requirements: 7.3_
  - [x] 4.2 Добавить функцию get_debt_by_holder_statistics
    - Группировка задолженностей по текущим держателям
    - _Requirements: 7.2_
  - [x] 4.3 Написать property test для статистики по держателям
    - **Property 11: Корректность группировки задолженностей по держателям**
    - **Validates: Requirements 7.2, 7.3**

- [x] 5. Реализация UI компонентов
  - [x] 5.1 Создать модальное окно DebtTransferModal
    - Создать файл `components/debt_transfer_modal.py`
    - Реализовать отображение текущего держателя и остатка
    - Реализовать выбор нового держателя
    - Реализовать поля даты и суммы
    - _Requirements: 8.1, 8.2_
  - [x] 5.2 Реализовать предзаполнение и вычисление разницы
    - Предзаполнение суммы текущим остатком
    - Отображение разницы при изменении суммы
    - _Requirements: 8.3, 8.5_
  - [x] 5.3 Написать property test для предзаполнения суммы
    - **Property 12: Предзаполнение суммы текущим остатком**
    - **Validates: Requirements 8.3**
  - [x] 5.4 Реализовать создание кредитора из модального окна
    - Кнопка "Создать кредитора"
    - Интеграция с LenderModal
    - _Requirements: 8.4_
  - [x] 5.5 Реализовать диалог подтверждения передачи
    - Показ информации о передаче
    - Кнопки подтверждения и отмены
    - _Requirements: 6.4_
  - [x] 5.6 Написать unit тесты для DebtTransferModal
    - Тест открытия модального окна
    - Тест валидации формы
    - Тест диалога подтверждения

- [x] 6. Интеграция с LoanDetailsView
  - [x] 6.1 Добавить секцию истории передач
    - Отображение списка передач в хронологическом порядке
    - Информация о каждой передаче: дата, от кого, кому, сумма, разница
    - _Requirements: 3.1, 3.2_
  - [x] 6.2 Добавить индикатор передачи в заголовок
    - Бейдж "Долг передан от X к Y"
    - _Requirements: 3.4_
  - [x] 6.3 Добавить кнопку "Передать долг"
    - Кнопка в секции истории передач
    - Открытие DebtTransferModal
    - _Requirements: 8.1_
  - [x] 6.4 Написать unit тесты для секции истории передач
    - Тест отображения истории
    - Тест индикатора передачи

- [x] 7. Интеграция с LoansView
  - [x] 7.1 Добавить индикатор передачи в список кредитов
    - Иконка или бейдж для переданных кредитов
    - _Requirements: 5.1, 5.2_
  - [x] 7.2 Добавить tooltip с информацией о передаче
    - "Передан от [Original] к [Current] [Date]"
    - _Requirements: 5.3_
  - [x] 7.3 Написать unit тесты для индикаторов в списке
    - Тест отображения индикатора
    - Тест содержимого tooltip

- [x] 8. Обновление UI для типа COLLECTOR
  - [x] 8.1 Добавить опцию "Коллектор" в LenderModal
    - Добавить COLLECTOR в dropdown выбора типа
    - _Requirements: 1.2_
  - [x] 8.2 Добавить иконку и цвет для типа COLLECTOR
    - Определить иконку (например, ft.Icons.ACCOUNT_BALANCE)
    - Определить цвет индикации
    - _Requirements: 1.3_
  - [x] 8.3 Написать unit тесты для отображения типа COLLECTOR
    - Тест наличия опции в dropdown
    - Тест отображения иконки

- [x] 9. Интеграция с отчётами
  - [x] 9.1 Обновить статистику по кредитам
    - Включить информацию о текущем держателе
    - _Requirements: 7.1_
  - [x] 9.2 Обновить сводные отчёты
    - Группировка по текущим держателям
    - _Requirements: 7.2_

- [x] 10. Финальный checkpoint
  - Запустить все тесты
  - Проверить интеграцию всех компонентов
  - Убедиться, что все требования покрыты
  - Спросить пользователя, если есть вопросы
  - Обновить дорожную карту проекта

## Notes

- Все задачи обязательны, включая тесты
- Каждая задача ссылается на конкретные требования для traceability
- Property tests используют Hypothesis с минимум 100 итерациями
- Checkpoints позволяют проверить прогресс и задать вопросы
