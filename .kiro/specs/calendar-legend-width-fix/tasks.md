# Implementation Plan: Calendar Legend Width Fix

## Overview

Исправление критических проблем с календарной легендой: корректировка завышенных оценок ширины индикаторов (с 670px до ~525px) и исправление неработающей кнопки "Подробнее" через улучшенный доступ к page объекту.

## Tasks

- [x] 1. Обновление оценок ширины индикаторов
  - Обновить INDICATOR_CONFIGS с реалистичными значениями ширины (30-60px вместо 60-85px)
  - Пересчитать общую требуемую ширину с ~670px до ~525px
  - Обновить приоритеты индикаторов при необходимости
  - Протестировать новые оценки с реальными размерами текста
  - _Requirements: 1.2, 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 1.1 Написать property тесты для оценок ширины
  - **Property 1: Realistic width estimation**
  - **Property 4: Text length consideration in width estimation**
  - **Validates: Requirements 1.2, 1.3, 3.1, 3.2, 3.3, 3.5**

- [x] 2. Создание WidthCalculator класса
  - Реализовать статические методы для точного вычисления ширины индикаторов
  - Добавить метод calculate_indicator_width() с учётом длины текста
  - Реализовать calculate_total_width() с правильными отступами
  - Добавить обработку ошибок и fallback значения
  - _Requirements: 1.3, 1.5, 3.4, 3.5_

- [x] 2.1 Написать property тесты для WidthCalculator
  - **Property 2: Accurate total width calculation**
  - **Validates: Requirements 1.5, 3.4**

- [x] 3. Создание PageAccessManager класса
  - Реализовать множественные стратегии получения page объекта
  - Добавить кэширование page объекта для повторного использования
  - Реализовать методы get_page(), cache_page(), is_page_available()
  - Добавить отладочное логирование для диагностики проблем доступа к page
  - _Requirements: 2.2, 2.5, 4.2_

- [x] 3.1 Написать property тесты для PageAccessManager
  - **Property 6: Page object access reliability**
  - **Property 8: Fallback behavior consistency**
  - **Validates: Requirements 2.2, 2.5, 4.2, 4.5**

- [x] 4. Обновление CalendarLegend класса
  - Интегрировать WidthCalculator в метод _calculate_required_width()
  - Обновить _should_show_full_legend() с новой логикой (порог 500px)
  - Заменить _safe_get_page() на использование PageAccessManager
  - Добавить отладочное логирование вычислений ширины
  - _Requirements: 1.1, 1.4, 4.4_

- [x] 4.1 Написать property тесты для обновлённой логики
  - **Property 3: Width-based display mode selection**
  - **Property 5: Responsive display mode updates**
  - **Validates: Requirements 1.1, 1.4, 4.3**

- [x] 5. Улучшение ModalManager класса
  - Обновить open_modal() для использования PageAccessManager
  - Добавить fallback уведомления при недоступности модального окна
  - Улучшить обработку ошибок в _close_modal_handler()
  - Добавить метод _show_fallback_notification() для пользователя
  - _Requirements: 2.1, 2.4, 5.1, 5.2_

- [x] 5.1 Написать property тесты для ModalManager
  - **Property 7: Modal dialog stability**
  - **Property 9: Error handling robustness**
  - **Validates: Requirements 5.1, 5.2, 5.5**

- [x] 6. Checkpoint - Тестирование основных исправлений
  - Убедиться, что все unit тесты проходят
  - Проверить новые оценки ширины с реальными индикаторами
  - Протестировать работу кнопки "Подробнее" в различных сценариях
  - Проверить отображение полной легенды при ширине календаря ≥ 500px
  - Убедиться в стабильной работе модального окна
  - Ensure all tests pass, ask the user if questions arise.

- [ ] 7. Создание отладочных утилит
  - Добавить DebugInfo dataclass для сбора диагностической информации
  - Реализовать метод _collect_debug_info() в CalendarLegend
  - Добавить логирование отладочной информации при проблемах
  - Создать метод _log_width_calculation_details() для детальной диагностики
  - _Requirements: 4.4_

- [ ] 7.1 Написать unit тесты для отладочных утилит
  - Тест создания DebugInfo с корректными данными
  - Тест логирования отладочной информации
  - Проверка сбора диагностических данных

- [x] 8. Интеграционное тестирование с HomeView
  - Протестировать передачу ширины календаря из HomeView
  - Проверить обновление режима отображения при изменении размеров окна
  - Убедиться в корректной интеграции с существующим календарём
  - Протестировать полный цикл: создание легенды → отображение → клик на "Подробнее"
  - _Requirements: 4.1, 4.3_

- [x] 8.1 Написать интеграционные тесты
  - Тест полного цикла работы легенды с исправленными ширинами
  - Тест интеграции с HomeView и календарным виджетом
  - Тест адаптивного поведения при изменении размеров окна

- [x] 9. Создание тестового скрипта для валидации
  - Создать скрипт test_legend_fixes.py для проверки исправлений
  - Добавить тесты с различными ширинами календаря (300px, 500px, 800px, 1000px)
  - Протестировать работу кнопки "Подробнее" в изолированной среде
  - Добавить визуальную проверку отображения всех индикаторов
  - _Requirements: все требования_

- [x] 9.1 Написать comprehensive property тесты
  - Комплексные property тесты для всех исправлений
  - Тесты граничных случаев (ширина календаря 499px vs 501px)
  - **Validates: все Requirements**

- [x] 10. Обновление документации и логирования
  - Обновить docstring'и методов с новой логикой
  - Добавить комментарии к новым константам ширины
  - Обновить сообщения логирования с более подробной информацией
  - _Requirements: 4.4, 5.5_

- [x] 11. Final checkpoint - Валидация в реальном приложении
  - Запустить приложение и проверить отображение легенды при разных размерах окна
  - Протестировать кнопку "Подробнее" в реальных условиях
  - Проверить логи на наличие ошибок или предупреждений
  - Убедиться, что полная легенда показывается при достаточной ширине календаря
  - Ensure all tests pass, ask the user if questions arise.

## Notes

- Все задачи являются обязательными для комплексного решения проблемы
- Каждая задача ссылается на конкретные требования для отслеживания
- Checkpoint'ы обеспечивают инкрементальную валидацию исправлений
- Property тесты валидируют универсальные свойства корректности
- Интеграционные тесты проверяют работу с существующими компонентами
- Основной фокус на исправлении оценок ширины (670px → 525px) и кнопки "Подробнее"