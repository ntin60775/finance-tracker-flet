# Implementation Plan: Кнопка добавления отложенных платежей

## Обзор

Реализация функционала добавления кнопки для создания новых отложенных платежей на панели отложенных платежей главного экрана и исправление кнопки "Показать всё".

## Задачи

- [x] 1. Обновить PendingPaymentsWidget с кнопкой добавления
  - Добавить параметр `on_add_payment` в конструктор
  - Создать кнопку `add_payment_button` с иконкой ADD
  - Обновить layout заголовка для размещения новой кнопки
  - _Requirements: 1.1, 4.1, 4.2, 4.3, 4.4_

- [x] 1.1 Написать unit тесты для кнопки добавления
  - **Property 1: Кнопка добавления существует и имеет правильные атрибуты**
  - **Validates: Requirements 1.1, 4.2, 4.3, 4.4**
  - Тест наличия кнопки в виджете
  - Тест атрибутов кнопки (иконка, tooltip, цвет)
  - Тест вызова callback при нажатии
  - _Requirements: 1.1, 1.2, 4.1, 4.2, 4.3, 4.4_

- [x] 2. Добавить метод create_pending_payment в HomePresenter
  - Реализовать метод с валидацией и обработкой ошибок
  - Добавить вызов сервиса создания платежа
  - Добавить commit и обновление данных через _refresh_data
  - Добавить логирование всех операций
  - _Requirements: 1.3, 3.2, 3.3, 6.2_

- [x] 2.1 Написать unit тесты для HomePresenter.create_pending_payment
  - Тест успешного создания платежа
  - Тест обработки ошибки валидации (ValueError)
  - Тест обработки ошибки БД (SQLAlchemyError)
  - Тест вызова _refresh_data после создания
  - Тест вызова show_message при успехе
  - Тест вызова show_error при ошибке
  - _Requirements: 1.3, 3.2, 3.4, 6.2_

- [x] 3. Обновить HomeView для интеграции модального окна
  - Обновить инициализацию PendingPaymentsWidget с новым callback
  - Обновить инициализацию PendingPaymentModal с правильным on_save
  - Добавить метод on_add_pending_payment для открытия модального окна
  - Добавить метод on_pending_payment_saved для обработки сохранения
  - Добавить обработку ошибок с логированием
  - _Requirements: 1.2, 3.1, 3.2, 3.4_

- [x] 3.1 Написать unit тесты для HomeView
  - Тест инициализации PendingPaymentModal с правильными callbacks
  - Тест открытия модального окна через on_add_pending_payment
  - Тест вызова page.open() с правильным модальным окном
  - Тест обработки сохранения через on_pending_payment_saved
  - Тест обработки ошибок при открытии модального окна
  - _Requirements: 1.2, 3.1, 3.2, 3.4_

- [x] 4. Реализовать навигацию к разделу отложенных платежей
  - Реализовать метод on_show_all_payments в HomeView
  - Добавить проверку наличия метода навигации в MainWindow
  - Добавить fallback с SnackBar если навигация не реализована
  - Добавить логирование навигации
  - _Requirements: 2.1, 7.1_

- [x] 4.1 Написать unit тесты для навигации
  - Тест вызова метода навигации при нажатии "Показать всё"
  - Тест fallback поведения если навигация не реализована
  - Тест показа SnackBar при отсутствии навигации
  - _Requirements: 2.1, 7.1_

- [x] 5. Checkpoint - Убедиться, что все базовые функции работают
  - Запустить приложение и проверить наличие кнопки "Добавить платёж"
  - Проверить открытие модального окна при нажатии кнопки
  - Проверить создание платежа через модальное окно
  - Проверить обновление виджета после создания
  - Проверить работу кнопки "Показать всё"
  - Если есть вопросы - спросить пользователя

- [x] 6. Написать property-based тесты для создания платежей
  - [x] 6.1 Property test: Создание платежа сохраняет в БД
    - **Property 1: Создание платежа сохраняет в БД**
    - **Validates: Requirements 1.3**
    - Генерировать случайные валидные данные платежа
    - Создавать платёж через сервис
    - Проверять наличие записи в БД с правильными данными
    - _Requirements: 1.3_

  - [x] 6.2 Property test: Создание платежа обновляет виджет
    - **Property 2: Создание платежа обновляет виджет**
    - **Validates: Requirements 1.4, 5.1**
    - Генерировать случайные валидные данные платежа
    - Создавать платёж через Presenter
    - Проверять вызов update_pending_payments
    - _Requirements: 1.4, 5.1_

  - [x] 6.3 Property test: Создание платежа обновляет статистику
    - **Property 3: Создание платежа обновляет статистику**
    - **Validates: Requirements 5.2**
    - Генерировать случайные валидные данные платежа
    - Получить статистику до создания
    - Создать платёж
    - Проверить увеличение total_active и total_amount
    - _Requirements: 5.2_

  - [x] 6.4 Property test: Платёж с датой отображается в календаре
    - **Property 4: Платёж с датой отображается в календаре**
    - **Validates: Requirements 5.3**
    - Генерировать случайные данные платежа с плановой датой
    - Создать платёж через Presenter
    - Проверить вызов update_calendar_data
    - _Requirements: 5.3_

  - [x] 6.5 Property test: Каскадное обновление компонентов
    - **Property 5: Каскадное обновление компонентов**
    - **Validates: Requirements 3.3**
    - Генерировать случайные валидные данные платежа
    - Создать платёж через Presenter
    - Проверить вызовы всех методов обновления (виджет, календарь, транзакции)
    - _Requirements: 3.3_

  - [x] 6.6 Property test: Валидация пустых полей
    - **Property 6: Валидация пустых полей**
    - **Validates: Requirements 6.1**
    - Генерировать невалидные данные (пустые поля, нулевая сумма)
    - Проверять, что Pydantic валидация отклоняет данные
    - Проверять, что запись не создаётся в БД
    - _Requirements: 6.1_

- [x] 7. Написать интеграционный тест полного цикла
  - Создать реальные компоненты (HomeView, Presenter, сессия БД)
  - Симулировать полный цикл: нажатие кнопки → заполнение формы → сохранение
  - Проверить создание записи в БД
  - Проверить обновление UI компонентов
  - Проверить показ уведомления об успехе
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 8. Финальный checkpoint - Убедиться, что все тесты проходят
  - Запустить все unit тесты: `pytest tests/test_*_view.py tests/test_*_presenter.py -v`
  - Запустить все property-based тесты: `pytest tests/test_*_properties.py -v`
  - Запустить интеграционные тесты: `pytest tests/test_integration*.py -v`
  - Если есть вопросы - спросить пользователя

## Примечания

- Все задачи являются обязательными для комплексной реализации с тестами
- Каждая задача ссылается на конкретные требования для трассируемости
- Checkpoints обеспечивают инкрементальную валидацию
- Property тесты валидируют универсальные свойства корректности
- Unit тесты валидируют конкретные примеры и граничные случаи
