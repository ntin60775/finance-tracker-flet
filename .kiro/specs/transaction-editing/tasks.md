# Implementation Plan

## Статус анализа

Проанализировав текущий код, обнаружено:

**Уже реализовано:**
- ✅ Модель `TransactionUpdate` в `models/models.py`
- ✅ Методы `update_transaction` и `delete_transaction` в `transaction_service.py`
- ✅ Базовая структура `TransactionsPanel` и `TransactionModal`
- ✅ Архитектура MVP с `HomePresenter` и `IHomeViewCallbacks`

**Требует реализации:**
- ❌ Кнопки действий (редактировать/удалить) в строках транзакций
- ❌ Режим редактирования в `TransactionModal`
- ❌ Методы обработки редактирования и удаления в `HomePresenter`
- ❌ Интеграция callback'ов в `HomeView`
- ❌ Диалог подтверждения удаления
- ❌ Тесты для новой функциональности

---

- [x] 1. Расширить TransactionsPanel для поддержки кнопок действ
  - Добавить параметры `on_edit_transaction` и `on_delete_transaction` в конструктор
  - Модифицировать `_build_transaction_tile` для создания `ListTile` с кнопками действий
  - Добавить кнопки редактирования (иконка карандаша) и удаления (иконка корзины)
  - Реализовать безопасные обработчики нажатий с проверкой callback'ов
  - _Requirements: 1.1, 1.2, 1.5, 9.2, 9.3_

- [x] 2. Расширить TransactionModal для режима редактирования
  - Добавить параметр `on_update` в конструктор для callback обновления
  - Добавить атрибуты `edit_mode` и `editing_transaction`
  - Реализовать метод `open_edit(page, transaction)` для открытия в режиме редактирования
  - Модифицировать заголовок окна в зависимости от режима
  - Реализовать предзаполнение полей данными транзакции при редактировании
  - Обновить логику сохранения для вызова правильного callback
  - _Requirements: 1.3, 1.4, 2.1, 2.2, 2.3, 2.4, 2.5, 7.1, 7.2, 7.3, 7.4, 7.5_

- [x] 3. Добавить методы редактирования и удаления в HomePresenter
  - Реализовать метод `update_transaction(transaction_id, data)` с вызовом сервиса
  - Реализовать метод `delete_transaction(transaction_id)` с вызовом сервиса
  - Добавить обработку ошибок и логирование для новых методов
  - Обеспечить вызов `_refresh_data()` после успешных операций
  - Добавить уведомления пользователя через callback'и
  - _Requirements: 3.1, 3.5, 6.2, 8.3, 8.4, 8.5_

- [x] 4. Интегрировать функциональность редактирования в HomeView
  - Добавить методы `on_edit_transaction` и `on_delete_transaction`
  - Реализовать `on_transaction_updated` для обработки сохранения изменений
  - Передать новые callback'и в `TransactionsPanel` при инициализации
  - Обновить создание `TransactionModal` с параметром `on_update`
  - Реализовать диалог подтверждения удаления с кнопками "Отмена" и "Удалить"
  - _Requirements: 1.2, 3.2, 3.3, 3.4, 4.1, 4.2, 4.3, 4.4, 4.5, 6.1, 6.5, 8.1, 8.2_

- [x] 5. Добавить валидацию и обработку ошибок
  - Реализовать валидацию полей в режиме редактирования
  - Добавить отображение ошибок валидации в UI
  - Обеспечить деактивацию кнопки "Сохранить" при наличии ошибок
  - Реализовать автоматическое исчезновение ошибок при исправлении
  - Добавить обработку ошибок сети и БД с показом пользователю
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ] 6. Добавить визуальные индикаторы интерактивности
  - Реализовать hover эффекты для кнопок действий
  - Добавить tooltip'ы для кнопок редактирования и удаления
  - Обеспечить компактный дизайн кнопок в строке транзакции
  - Добавить визуальное отключение недоступных элементов
  - _Requirements: 9.1, 9.4, 9.5_

- [ ] 7. Написать unit тесты для TransactionsPanel
  - Тест создания кнопок действий для транзакции
  - Тест вызова callback при нажатии кнопки редактирования
  - Тест вызова callback при нажатии кнопки удаления
  - Тест безопасной обработки null callback'ов
  - _Requirements: 10.1_

- [ ] 8. Написать unit тесты для TransactionModal
  - Тест открытия в режиме создания (существующая функциональность)
  - Тест открытия в режиме редактирования с предзаполнением
  - Тест валидации при редактировании
  - Тест вызова on_update при сохранении в режиме редактирования
  - Тест правильного заголовка в зависимости от режима
  - _Requirements: 10.2_

- [ ] 9. Написать unit тесты для HomePresenter
  - Тест update_transaction с валидными данными
  - Тест update_transaction с ошибкой
  - Тест delete_transaction с подтверждением
  - Тест обновления UI после операций
  - _Requirements: 10.3_

- [ ] 10. Написать property-based тесты
  - **Property 1: Кнопки действий для всех транзакций**
  - **Property 2: Предзаполнение полей при редактировании**
  - **Property 3: Валидация суммы**
  - **Property 6: Сохранение вызывает update_transaction**
  - **Property 8: Отмена не сохраняет данные**
  - **Property 9: Удаление вызывает delete_transaction**
  - _Requirements: 10.4_

- [ ] 11. Написать integration тесты
  - Полный сценарий редактирования транзакции (UI -> Presenter -> Service -> DB -> UI)
  - Полный сценарий удаления транзакции
  - Проверка обновления календаря после изменений
  - _Requirements: 10.5_

- [ ] 12. Checkpoint - Убедиться что все тесты проходят
  - Ensure all tests pass, ask the user if questions arise.